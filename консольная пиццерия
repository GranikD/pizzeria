import re
import json
from datetime import datetime

bd_FILE = "bd.json"

print("Добро пожаловать в пиццерию Пика-Чика")
print("=" * 37)

def load_bd():
    # Загружаем базу данных из файла или создает новую при отсутствии
    try:
        # Пытаемся открыть файл для чтения
        with open(bd_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
            # filenotfounderror - если файл не найден
            # decodeerror - если код поврежден
    except (FileNotFoundError, json.JSONDecodeError):
        # Если файл не найден или поврежден создаем новую бд
        return {"users": [], "orders": [], "next_order_id": 1}

    # Сохраняет базу данных в файл
def save_bd(bd):            # Честно - не разобрался что это(по идее преобразование строки в байты),
                            # но при запуске базы данных возникала ошибка где было указано: "The file was loaded in a wrong encoding:"UTF-8""
    with open(bd_FILE, "w", encoding="utf-8") as f:
        # Преобразование словаря в JSON с форматированием
                         # Используем значение false для того что бы в бд символы оставались как есть
        json.dump(bd, f, ensure_ascii=False, indent=2)


# Загрузка базы данных при старте программы
bd = load_bd()

# Приветствует пользователя
def say_hello(name):
    print(f"привет, {name}")

# Проверяет корректность имени (только буквы и пробелы)
def is_valid_name(name):
    name_without_spaces = name.replace(" ", "")  # Удаляем пробелы
    # Метод isalpha() проверяет, что строка состоит только из букв
    return name_without_spaces.isalpha() and len(name.strip()) > 0

# Проверяет корректность даты (формат ДД/ММ/ГГГГ и не будущая дата)
def is_valid_date(date_str):
    # Проверка формата ДД/ММ/ГГГГ
    if len(date_str) != 10 or date_str[2] != '/' or date_str[5] != '/':
        return False
    try:
        # Разбиваем строку на части и преобразуем в числа
        day, month, year = map(int, date_str.split('/'))
        # Создаем объект datetime (может вызвать исключение при неверной дате)
        input_date = datetime(year, month, day)
    except:
        return False
    # Задаем переменной значение текущей даты
    current_date = datetime.now()
    if input_date > current_date:
        return False
    return True

# Проверяет корректность email с помощью регулярного выражения
def is_valid_email(email):
    pattern = r'[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]'
    # re.match проверяет соответствие строки шаблону с начала строки
    return bool(re.match(pattern, email))

# Проверяет корректность номера телефона (формат +7XXXXXXXXXX)
def is_valid_phone(phone):
                                                                    # Проверяет все ли символы цифры
    return phone.startswith('+7') and len(phone) == 12 and phone[1:].isdigit()

# Создает кастомную пиццу с выбором ингредиентов
def create_custom_pizza():
    ingredients = {
        "1": {"name": "сыр", "цена": 50},
        "2": {"name": "пеперони", "цена": 80},
        "3": {"name": "оливки", "цена": 40},
        "4": {"name": "соус", "цена": 30},
        "5": {"name": "помидоры", "цена": 35}
    }

    print("\nСоздание кастомной пиццы:")
    print("Доступные ингредиенты:")
    for num, ing in ingredients.items():
        print(f"{num}. {ing['name']} - {ing['цена']} руб")
    print("0. Завершить выбор ингредиентов")

    custom_price = 200  # Базовая цена(условно цена теста)
    selected_ingredients = []  # Список с выбранными ингредиентами

    while True:
        choice = input("\nВыберите ингредиент (номер): ").strip()
        if choice == '0':
            break
        elif choice in ingredients:
            ingredient = ingredients[choice]
            # Проверяем, не добавлен ли уже ингредиент
            if ingredient['name'] not in selected_ingredients:
                selected_ingredients.append(ingredient['name'])
                custom_price += ingredient['цена']
                print(f"Добавлен: {ingredient['name']}")
            else:
                print("Этот ингредиент уже добавлен")
        else:
            print("Неверный номер ингредиента")

    # Формируем описание пиццы
    if selected_ingredients:
                               # Объединяем список в строку
        ingredients_str = ", ".join(selected_ingredients)
        return f"Кастомная пицца ({ingredients_str})", custom_price
    else:
        return "Кастомная пицца (базовая)", custom_price

# Ищет пользователя в бд по email или телефону
def find_user(email, phone):
    for u in bd["users"]:
        # Метод get() словаря - получение значения
        if u.get("email") == email or u.get("phone") == phone:
            return u
    return None


# Блок регистрации пользователя
while True:
    name = input("введите ваше имя: ").strip()
    if is_valid_name(name):
        break
    else:
        print("Ошибка! Имя должно содержать только буквы и пробелы. Попробуйте еще раз.")

say_hello(name)

while True:
    birthday = input("\nвведите вашу дату рождения (ДД/ММ/ГГГГ): ").strip()
    if is_valid_date(birthday):
        day, month, year = map(int, birthday.split('/'))
        birthday_obj = datetime(year, month, day)
        current_date = datetime.now()
        # Вычисление возраста с учетом месяца и дня
        age = current_date.year - birthday_obj.year
        break
    else:
        print("Ошибка! Дата должна быть в формате ДД/ММ/ГГГГ и не может быть в будущем. Пример: 15/05/1990")

while True:
    email = input("\nВведите ваш email: ").strip()
    if is_valid_email(email):
        break
    else:
        print("Ошибка! почта должна быть в формате piminov@gmail.com или piminov@mail.ru")

while True:
    phone = input("\nВведите ваш телефон (+7XXXXXXXXXX): ").strip()
    if is_valid_phone(phone):
        break
    else:
        print("Ошибка! Телефон должен начинаться с +7 и содержать 11 цифр. Пример: +79123456789")

print('-' * 20)
print(f"\nРегистрация завершена:\n"
      f"Возраст: {age} лет\n"
      f"Email: {email}\n"
      f"Телефон: {phone}\n")

# Сохранение пользователя в бд
existing_user = find_user(email, phone)
if existing_user:
    # Обновление данных существующего пользователя
    existing_user.update({
        "name": name,
        "birthday": birthday,
        "age": age,
        "email": email,
        "phone": phone
    })
    user = existing_user
else:
    # Создание нового пользователя
    user = {
        "name": name,
        "birthday": birthday,
        "age": age,
        "email": email,
        "phone": phone
    }
    bd["users"].append(user)  # Добавление в список пользователей

save_bd(bd)  # Сохранение бд после регистрации

# Меню для несовершеннолетних
pizzas_minors = {
    "1": {"name": "пеперони", "цена": 400},
    "2": {"name": "сырная", "цена": 350},
    "3": {"name": "кастомная", "цена": "расчетная"}
}

# Меню для взрослых (с большими порциями)
pizzas_adults = {
    "1": {"name": "пеперони", "цена": 400},
    "2": {"name": "пеперони(б)", "цена": 500},
    "3": {"name": "сырная", "цена": 350},
    "4": {"name": "сырная(б)", "цена": 450},
    "5": {"name": "кастомная", "цена": "расчетная"}
}

drinks_minors = {
    "1": {"name": "сок", "цена": 100},
    "2": {"name": "кола", "цена": 120}
}

drinks_adults = {
    "1": {"name": "сок", "цена": 100},
    "2": {"name": "сок(б)", "цена": 130},
    "3": {"name": "кола", "цена": 120},
    "4": {"name": "кола(б)", "цена": 150}
}

order_items = []  # Список для ссохранения товаров
total = 0  # Сумма заказа

print(f"Вам {age} лет")

# Цикл создания заказа
while True:
    # Выбор меню в зависимости от возраста
    if age < 18:
        current_pizzas = pizzas_minors
        current_drinks = drinks_minors
    else:
        current_pizzas = pizzas_adults
        current_drinks = drinks_adults

    print("\nВам доступно следующее меню:")
    print('-' * 30)
    print("ПИЦЦЫ:")
    for num, pizza in current_pizzas.items():
        print(f"{num}. {pizza['name']} - {pizza['цена']} руб")

    print("\nНАПИТКИ:")
    for num, drink in current_drinks.items():
        print(f"{num}. {drink['name']} - {drink['цена']} руб")

    pizza_choice = input("\nВыберите пиццу (номер) или 0 для вывода чека: ").strip()
    if pizza_choice == '0':
        break
    elif pizza_choice in current_pizzas:
        pizza = current_pizzas[pizza_choice]
        if pizza['name'] == 'кастомная':
            # Создание кастомной пиццы
            custom_name, custom_price = create_custom_pizza()
            order_items.append({"name": custom_name, "цена": custom_price})
            total += custom_price
        else:
            price = pizza['цена']
            order_items.append({"name": f"Пицца {pizza['name']}", "цена": price})
            total += price
    else:
        print("Неверный номер пиццы")
        continue

    print("\nНАПИТКИ:")
    for num, drink in current_drinks.items():
        print(f"{num}. {drink['name']} - {drink['цена']} руб")

    drink_choice = input("\nВыберите напиток (номер) или 0 для вывода чека: ").strip()
    if drink_choice == '0':
        break
    elif drink_choice in current_drinks:
        drink = current_drinks[drink_choice]
        price = drink['цена']
        order_items.append({"name": drink['name'], "цена": price})
        total += price
    else:
        print("Неверный номер напитка")

# Сохранение заказа в бд
if order_items:
    order_id = bd.get("next_order_id")
    order_record = {
        "order_id": order_id,
        "user_email": user.get("email"),
        "user_phone": user.get("phone"),
        "items": order_items,
        "total": total
    }
    bd["orders"].append(order_record)
    bd["next_order_id"] = order_id + 1
    save_bd(bd)

print("\n" + "=" * 35)
print("ЧЕК")
print("=" * 35)
for item in order_items:
    print(f"{item['name']} - {item['цена']} руб")
print("=" * 35)
print(f"ИТОГО: {total} руб")
print("=" * 35)
print("Спасибо за заказ!")
